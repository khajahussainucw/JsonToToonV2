<div class="paddingLeftRight" >
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span class="fw-bold">
        <span class="d-none d-md-inline">Copy and Paste JSON in the following area</span>
        <span class="d-inline d-md-none">Enter JSON here</span>
      </span>
      <div class="action-buttons">

        <button class="btn btn-sm btn-dark  animate__animated animate__flipInX" *ngIf="hasValidJson" (click)="openTableModal()">
          <i class="fas fa-expand"></i>
          <span class="d-none d-md-inline"> Maximize</span>
        </button>

        <button class="btn btn-sm btn-dark" *ngIf="hasValidJson" (click)="toggleParentTranspose()" 
                [class.active]="isParentTransposed" title="Transpose main table">
          <i class="fas fa-arrows-rotate"></i>
          <span class="d-none d-lg-inline"> Main</span>
        </button>

        <button class="btn btn-sm btn-dark" *ngIf="hasValidJson" (click)="toggleChildTranspose()" 
                [class.active]="isChildTransposed" title="Transpose nested tables">
          <i class="fas fa-arrows-rotate"></i>
          <span class="d-none d-lg-inline"> Nested</span>
        </button>

        <button class="btn btn-sm btn-dark  " (click)="downloadAsExcel()" *ngIf="hasValidJson">
          <i class="fas fa-file-excel"></i>
          <span class="d-none d-md-inline"> Excel</span>
        </button>

        <button class="btn btn-sm btn-dark" (click)="loadSampleData()">
          <i class="fas fa-flask"></i>
          <span class="d-none d-md-inline"> Sample</span>
        </button>
        <button class="btn btn-sm btn-dark" *ngIf="hasValidJson" (click)="toggleEditMode()" [class.active]="isEditMode">
          <i class="fas fa-pen"></i>
          <span class="d-none d-md-inline"> {{ isEditMode ? 'Done' : 'Edit' }} </span>
        </button>

        <button class="btn btn-sm btn-dark" (click)="openShareModal()">
          <i class="fas fa-share-square"></i>
          <span class="d-none d-md-inline"> Share</span>
        </button>
        <button class="btn btn-sm btn-dark" data-bs-toggle="modal" data-bs-target="#infoModal">
          <i class="fas fa-info-circle"></i>
          <!--<span class="d-none d-md-inline"> Info</span>-->
        </button>

      </div>
    </div>
    <div class="card-body p-0" style="position: relative;">
      <div class="split-loading" *ngIf="isLoading">
        <div class="spinner-container">
          <div class="spinner-border text-secondary" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <div class="loading-message mt-2">Loading data...</div>
        </div>
      </div>
      <div class="split-container">
        <div class="json-input-container" style="flex: 0.22 1 0%;">
          <div #editor class="editor"></div>
          <!--<div class="error-bar" *ngIf="errorMessage">
            <div class="error-message">
              <i class="fas fa-exclamation-circle text-danger"></i> {{ errorMessage }}
            </div>
          </div>-->
        </div>
        
        <div class="splitter" id="splitter" #splitter></div>
        
        <div class="table-output-container" style="flex: 0.78 1 0%;">
          <div class="table-container" #tableContainer>
            <div class="filter-status text-muted small mb-1" *ngIf="hasValidJson && tableData.length > 0 && filteredData.length !== tableData.length">
              Showing {{ filteredData.length }} of {{ tableData.length }} rows
            </div>
            <ng-container *ngIf="hasValidJson">
              <ng-container *ngIf="tableData.length > 0">
                <ng-container *ngIf="!isSingleObject; else singleObjectTpl">
                  <!-- Flat table for array of objects -->
                  <!-- Standard orientation (keys as columns) -->
                  <table class="table" *ngIf="columns.length > 0 && !isParentTransposed">
                    <thead>
                      <tr>
                        <th *ngFor="let col of columns" class="position-relative">
                          <b>{{ col }}</b>
                          <button *ngIf="isEditMode" type="button" class="btn btn-link p-0 m-1 column-remove" title="Remove column" (click)="removeColumn(col)"><i class="fas fa-times "></i></button>
                        </th>
                      </tr>
                      <tr>
                        <th *ngFor="let col of columns">
                          <input type="text" class="form-control form-control-sm"
                                 (input)="updateFilter(col, $any($event.target).value)"
                                 [value]="filters[col] || ''" placeholder="Filter" />
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let row of filteredData; let i = index">
                        <td *ngFor="let col of columns" (dblclick)="isEditMode && startEdit(i, col)">
                          <ng-container *ngIf="(isArray(row[col]) || isObject(row[col])) && !(editingRow === i && editingCol === col); else defaultCell">
                            <ng-container *ngTemplateOutlet="recursiveTable; context: { $implicit: row[col], isChild: true }"></ng-container>
                          </ng-container>
                          <ng-template #defaultCell>
                              <ng-container *ngIf="isEditMode && editingRow === i && editingCol === col; else valueTpl">
                                <input type="text" class="form-control form-control-sm"
                                       [value]="getEditValue(row[col])"
                                       (blur)="saveEdit(i, col, $any($event.target).value)"
                                       (keydown.enter)="saveEdit(i, col, $any($event.target).value)" />
                              </ng-container>
                              <ng-template #valueTpl>{{ formatValue(row[col]) }}</ng-template>
                            </ng-template>
                        </td>
                      </tr>
                    </tbody>
                  </table>

                  <!-- Transposed orientation (keys as rows) -->
                  <table class="table" *ngIf="columns.length > 0 && isParentTransposed">
                    <tbody>
                      <tr *ngFor="let key of columns">
                        <td class="nested-key"><b>{{ key }}</b></td>
                        <td *ngFor="let item of filteredData">
                          <ng-container *ngIf="isArray(item[key]) || isObject(item[key]); else primitiveTop">
                            <ng-container *ngTemplateOutlet="recursiveTable; context: { $implicit: item[key], isChild: true }"></ng-container>
                          </ng-container>
                          <ng-template #primitiveTop>{{ formatValue(item[key]) }}</ng-template>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </ng-container>
                <ng-template #singleObjectTpl>
                  <!-- Single object as key-value table -->
                  <table class="table">
                    <tbody>
                      <tr *ngFor="let key of columns; let i = index">
                        <td class="nested-key position-relative">
                          <b>{{ key }}</b>
                          <button *ngIf="isEditMode" type="button" class="btn btn-link p-0 m-1 column-remove" title="Remove column" (click)="removeColumn(key)"><i class="fas fa-times "></i></button>
                        </td>
                        <td (dblclick)="isEditMode && startEdit(0, key)">
                          <ng-container *ngIf="(isArray(tableData[0][key]) || isObject(tableData[0][key])) && !(isEditMode && editingRow === 0 && editingCol === key); else singleObjectCell">
                            <ng-container *ngTemplateOutlet="recursiveTable; context: { $implicit: tableData[0][key], isChild: true }"></ng-container>
                          </ng-container>
                          <ng-template #singleObjectCell>
                            <ng-container *ngIf="isEditMode && editingRow === 0 && editingCol === key; else singleObjectValue">
                              <input type="text" class="form-control form-control-sm"
                                     [value]="getEditValue(tableData[0][key])"
                                     (blur)="saveEdit(0, key, $any($event.target).value)"
                                     (keydown.enter)="saveEdit(0, key, $any($event.target).value)" />
                            </ng-container>
                            <ng-template #singleObjectValue>{{ formatValue(tableData[0][key]) }}</ng-template>
                          </ng-template>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </ng-template>
              </ng-container>
            </ng-container>
            <div *ngIf="!hasValidJson && errorMessage" class="invalid-json-message">
              <div class="basic-message">
                {{ errorMessage }}
              </div>
            </div>
            <div *ngIf="hasValidJson && tableData.length === 0" class="no-data">
              Enter valid JSON array to see the table
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Recursive template for nested structures -->
<ng-template #recursiveTable let-data let-isChild="isChild">
  <ng-container [ngSwitch]="true">
    <!-- Array handling -->
    <ng-container *ngSwitchCase="isArray(data)">
      <!-- Complex array of objects -->
      <ng-container *ngIf="data.length > 0 && hasComplexItems(data)">
        <!-- Determine if this table should be transposed -->
        <ng-container *ngIf="!(isChild ? isChildTransposed : isParentTransposed)">
          <!-- Standard view: each key becomes a row, each array item becomes a column -->
          <table class="table">
        <tbody>
          <tr *ngFor="let key of getCommonKeys(data)">
            <td class="nested-key"><b>{{ key }}</b></td>
            <td *ngFor="let item of data">
              <ng-container *ngIf="isArray(item[key]) || isObject(item[key]); else primitiveV">
                    <ng-container *ngTemplateOutlet="recursiveTable; context: { $implicit: item[key], isChild: true }"></ng-container>
              </ng-container>
              <ng-template #primitiveV>{{ formatValue(item[key]) }}</ng-template>
            </td>
          </tr>
        </tbody>
      </table>
        </ng-container>
        <ng-container *ngIf="isChild ? isChildTransposed : isParentTransposed">
          <!-- Transposed view: each key becomes a column, each array item becomes a row -->
          <table class="table">
            <thead>
              <tr>
                <th *ngFor="let key of getCommonKeys(data)"><b>{{ key }}</b></th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of data">
                <td *ngFor="let key of getCommonKeys(data)">
                  <ng-container *ngIf="isArray(item[key]) || isObject(item[key]); else primitiveVT">
                    <ng-container *ngTemplateOutlet="recursiveTable; context: { $implicit: item[key], isChild: true }"></ng-container>
                  </ng-container>
                  <ng-template #primitiveVT>{{ formatValue(item[key]) }}</ng-template>
                </td>
              </tr>
            </tbody>
          </table>
        </ng-container>
      </ng-container>
      <!-- Simple array of primitives -->
      <table class="table" *ngIf="data.length > 0 && !hasComplexItems(data)">
        <tbody>
          <tr *ngFor="let item of data">
            <td>{{ formatValue(item) }}</td>
          </tr>
        </tbody>
      </table>
      <!-- Empty array -->
      <span *ngIf="data.length === 0">[]</span>
    </ng-container>

    <!-- Object handling -->
    <ng-container *ngSwitchCase="isObject(data)">
      <!-- Standard (keys as rows) -->
      <table class="table" *ngIf="!(isChild ? isChildTransposed : isParentTransposed)">
        <tbody>
          <tr *ngFor="let key of getObjectKeys(data)">
            <td class="nested-key"><b>{{ key }}</b></td>
            <td>
              <ng-container *ngTemplateOutlet="recursiveTable; context: { $implicit: data[key], isChild: true }"></ng-container>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Transposed (keys as columns) -->
      <table class="table" *ngIf="isChild ? isChildTransposed : isParentTransposed">
        <thead>
          <tr>
            <th *ngFor="let key of getObjectKeys(data)"><b>{{ key }}</b></th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td *ngFor="let key of getObjectKeys(data)">
              <ng-container *ngTemplateOutlet="recursiveTable; context: { $implicit: data[key], isChild: true }"></ng-container>
            </td>
          </tr>
        </tbody>
      </table>
    </ng-container>

    <!-- Primitive value handling -->
    <ng-container *ngSwitchDefault>
      {{ data }}
    </ng-container>
  </ng-container>
</ng-template>

<!-- Fullscreen modal for maximized table -->
<div class="modal fade" id="tableModal" tabindex="-1" aria-labelledby="tableModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable" style="max-width:98vw; ">
    <div class="modal-content" style="height:96vh !important; ">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title d-flex align-items-center" id="tableModalLabel">
          <i class="fas fa-expand me-2"></i>
          Maximized Table View
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" (click)="closeTableModal()"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex justify-content-end mb-3 gap-2">
          <button class="btn btn-sm btn-outline-dark" (click)="toggleParentTranspose()" 
                  [class.active]="isParentTransposed" title="Transpose main table">
            <i class="fas fa-arrows-rotate"></i> Main
          </button>
          <button class="btn btn-sm btn-outline-dark" (click)="toggleChildTranspose()" 
                  [class.active]="isChildTransposed" title="Transpose nested tables">
            <i class="fas fa-arrows-rotate"></i> Nested
          </button>
          <button class="btn btn-sm btn-outline-dark" (click)="toggleEditMode()"
                  [class.active]="isEditMode" title="Edit mode">
            <i class="fas fa-pen"></i> Edit
          </button>
        </div>
        <div class="">
          <div class="filter-status text-muted small mb-1" *ngIf="tableData.length > 0 && filteredData.length !== tableData.length">
            Showing {{ filteredData.length }} of {{ tableData.length }} rows
          </div>
          <ng-container *ngIf="tableData.length > 0">
            <ng-container *ngIf="!isSingleObject; else singleObjectTplModal">
              <!-- Standard orientation (keys as columns) -->
              <table class="table" *ngIf="columns.length > 0 && !isParentTransposed">
                <thead>
                  <tr>
                    <th *ngFor="let col of columns" class="position-relative">
                      <b>{{ col }}</b>
                      <button *ngIf="isEditMode" type="button" class="btn btn-link p-0 m-1 column-remove" title="Remove column" (click)="removeColumn(col)"><i class="fas fa-times "></i></button>
                    </th>
                  </tr>
                  <tr>
                    <th *ngFor="let col of columns">
                      <input type="text" class="form-control form-control-sm"
                             (input)="updateFilter(col, $any($event.target).value)"
                             [value]="filters[col] || ''" placeholder="Filter" />
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let row of filteredData; let i = index">
                    <td *ngFor="let col of columns" (dblclick)="isEditMode && startEdit(i, col)">
                      <ng-container *ngIf="(isArray(row[col]) || isObject(row[col])) && !(editingRow === i && editingCol === col); else defaultCellModal">
                        <ng-container *ngTemplateOutlet="recursiveTable; context: { $implicit: row[col], isChild: true }"></ng-container>
                      </ng-container>
                      <ng-template #defaultCellModal>
                        <ng-container *ngIf="isEditMode && isEditMode && editingRow === i && editingCol === col; else valueTplModal">
                          <input type="text" class="form-control form-control-sm"
                                 [value]="getEditValue(row[col])"
                                 (blur)="saveEdit(i, col, $any($event.target).value)"
                                 (keydown.enter)="saveEdit(i, col, $any($event.target).value)" />
                        </ng-container>
                        <ng-template #valueTplModal>{{ formatValue(row[col]) }}</ng-template>
                      </ng-template>
                    </td>
                  </tr>
                </tbody>
              </table>

              <!-- Transposed orientation (keys as rows) -->
              <table class="table" *ngIf="columns.length > 0 && isParentTransposed">
                <tbody>
                  <tr *ngFor="let key of columns">
                    <td class="nested-key"><b>{{ key }}</b></td>
                    <td *ngFor="let item of filteredData">
                      <ng-container *ngIf="isArray(item[key]) || isObject(item[key]); else primitiveTopModal">
                        <ng-container *ngTemplateOutlet="recursiveTable; context: { $implicit: item[key], isChild: true }"></ng-container>
                      </ng-container>
                      <ng-template #primitiveTopModal>{{ formatValue(item[key]) }}</ng-template>
                    </td>
                  </tr>
                </tbody>
              </table>
            </ng-container>
            <ng-template #singleObjectTplModal>
              <!-- Single object as key-value table -->
              <table class="table">
                <tbody>
                  <tr *ngFor="let key of columns; let i = index">
                    <td class="nested-key position-relative">
                      <b>{{ key }}</b>
                      <button *ngIf="isEditMode" type="button" class="btn btn-link p-0 m-1 column-remove" title="Remove column" (click)="removeColumn(key)"><i class="fas fa-times "></i></button>
                    </td>
                    <td (dblclick)="isEditMode && startEdit(0, key)">
                      <ng-container *ngIf="(isArray(tableData[0][key]) || isObject(tableData[0][key])) && !(isEditMode && editingRow === 0 && editingCol === key); else singleObjectCellModal">
                        <ng-container *ngTemplateOutlet="recursiveTable; context: { $implicit: tableData[0][key], isChild: true }"></ng-container>
                      </ng-container>
                      <ng-template #singleObjectCellModal>
                        <ng-container *ngIf="isEditMode && editingRow === 0 && editingCol === key; else singleObjectValueModal">
                          <input type="text" class="form-control form-control-sm"
                                 [value]="getEditValue(tableData[0][key])"
                                 (blur)="saveEdit(0, key, $any($event.target).value)"
                                 (keydown.enter)="saveEdit(0, key, $any($event.target).value)" />
                        </ng-container>
                        <ng-template #singleObjectValueModal>{{ formatValue(tableData[0][key]) }}</ng-template>
                      </ng-template>
                    </td>
                  </tr>
                </tbody>
              </table>
            </ng-template>
          </ng-container>
          <div *ngIf="tableData.length === 0 && errorMessage" class="no-data">
            Enter valid JSON array to see the table
          </div>
        </div>
      </div>
      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-sm btn-dark" data-bs-dismiss="modal" (click)="closeTableModal()">
          <i class="fas fa-times"></i>
          <span class="d-none d-md-inline"> Close</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Info Modal -->
<div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white py-3">
        <h5 class="modal-title d-flex align-items-center fs-4" id="infoModalLabel">
          <i class="fas fa-info-circle me-3"></i>
          JSON Parser Tool
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="welcome-section mb-4">
          <p class="lead">About This Tool</p>
          <p class="text-muted">Paste your JSON and see it instantly converted into an HTML table. Works with nested objects, arrays, and complex data structures.</p>
          <p class="text-muted">Useful when you need to quickly visualize JSON data, debug API responses, or share data in a readable format. No installation, no configuration—just paste and view.</p>
        </div>

        <div class="features-section mb-5">
          <h6 class="section-title fs-5 mb-4">What You Can Do</h6>
          <div class="row">
            <div class="col-md-6">
              <ul class="list-unstyled">
                <li class="feature-item mb-4">
                  <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-magic text-primary me-3 fs-5"></i>
                    <strong>Nested Data Support</strong>
                  </div>
                  <p class="text-muted ms-4">Arrays and objects inside your JSON are automatically converted into nested tables.</p>
                </li>
                <li class="feature-item mb-4">
                  <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-bolt text-warning me-3 fs-5"></i>
                    <strong>Live Preview</strong>
                  </div>
                  <p class="text-muted ms-4">Type or paste JSON and watch the table update in real-time as you edit.</p>
                </li>
                <li class="feature-item mb-4">
                  <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-table text-success me-3 fs-5"></i>
                    <strong>Edit Mode</strong>
                  </div>
                  <p class="text-muted ms-4">Click "Edit" to modify table values directly. Changes sync back to the JSON editor.</p>
                </li>
              </ul>
            </div>
            <div class="col-md-6">
              <ul class="list-unstyled">
                <li class="feature-item mb-4">
                  <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-file-export text-info me-3 fs-5"></i>
                    <strong>Export to Excel</strong>
                  </div>
                  <p class="text-muted ms-4">Click "Excel" to download the table as an .xls file you can open in Excel or Google Sheets.</p>
                </li>
                <li class="feature-item mb-4">
                  <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-expand-arrows-alt text-danger me-3 fs-5"></i>
                    <strong>Fullscreen Mode</strong>
                  </div>
                  <p class="text-muted ms-4">Hit "Maximize" to view the table fullscreen with column filters and search.</p>
                </li>
                <li class="feature-item mb-4">
                  <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-code text-secondary me-3 fs-5"></i>
                    <strong>Share with Others</strong>
                  </div>
                  <p class="text-muted ms-4">Use "Share" to generate a URL that loads your JSON. Expires after your selected period.</p>
                </li>
              </ul>
            </div>
          </div>
        </div>

        <div class="usage-section mb-5">
          <h6 class="section-title fs-5 mb-4">Quick Start</h6>
          <div class="usage-steps">
            <div class="step mb-3">
              <div class="d-flex align-items-center mb-2">
                <span class="badge bg-primary me-3">1</span>
                <strong>Paste JSON</strong>
              </div>
              <p class="text-muted ms-5">Copy JSON from your API, file, or code and paste it in the left editor. Click "Sample" to see an example.</p>
            </div>
            <div class="step mb-3">
              <div class="d-flex align-items-center mb-2">
                <span class="badge bg-primary me-3">2</span>
                <strong>View Table</strong>
              </div>
              <p class="text-muted ms-5">The table appears instantly on the right. Nested data gets its own expandable tables.</p>
            </div>
            <div class="step mb-3">
              <div class="d-flex align-items-center mb-2">
                <span class="badge bg-primary me-3">3</span>
                <strong>Export or Share</strong>
              </div>
              <p class="text-muted ms-5">Download as Excel, maximize for filtering, or share with teammates via URL.</p>
            </div>
          </div>
        </div>

        <div class="pro-tips-section mb-5">
          <h6 class="section-title fs-5 mb-4">Tips</h6>
          <div class="tips-container bg-light p-4 rounded">
            <ul class="mb-0">
              <li class="mb-2">Click "Main" or "Nested" to transpose tables (swap rows and columns)</li>
              <li class="mb-2">Use fullscreen mode to filter columns by typing in the header row</li>
              <li class="mb-2">Double-click any cell in Edit mode to change the value</li>
              <li>Invalid JSON will show an error—check for missing quotes or commas</li>
            </ul>
          </div>
        </div>

        <div class="support-section text-center mt-5">
          <p class="text-muted small">
            Questions or feedback? Use the Contact link in the footer.
          </p>
        </div>
      </div>
      <div class="modal-footer bg-light">

        <button type="button" class="btn btn-sm btn-dark" data-bs-dismiss="modal" (click)="loadSampleData()">
          <i class="fas fa-flask"></i>
          <span class="d-none d-md-inline"> Try Sample</span>
        </button>

        <button type="button" class="btn btn-sm btn-dark" data-bs-dismiss="modal">
          <i class="fas fa-times"></i>
          <span class="d-none d-md-inline"> Close</span>
        </button>

      </div>
    </div>
  </div>
</div>

<app-share-modal [jsonData]="getEditorContent()"></app-share-modal>
